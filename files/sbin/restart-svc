#!/bin/sh

# Copyright (c) 2014-2017 Simon Deziel <simon.deziel@gmail.com>

# Permission to use, copy, modify, and distribute this software for any
# purpose with or without fee is hereby granted, provided that the above
# copyright notice and this permission notice appear in all copies.

# THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES
# WITH REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF
# MERCHANTABILITY AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR
# ANY SPECIAL, DIRECT, INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES
# WHATSOEVER RESULTING FROM LOSS OF USE, DATA OR PROFITS, WHETHER IN AN
# ACTION OF CONTRACT, NEGLIGENCE OR OTHER TORTIOUS ACTION, ARISING OUT OF
# OR IN CONNECTION WITH THE USE OR PERFORMANCE OF THIS SOFTWARE.

# Explicitly set the PATH to that of ENV_SUPATH in /etc/login.defs and unset
# various other variables. For details, see:
# https://wiki.ubuntu.com/SecurityTeam/AppArmorPolicyReview#Execute_rules
export PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
export ENV=
export CDPATH=

CHECK_DELETED_LIBS="$(/usr/bin/which check-deleted-libs 2>/dev/null)"

# Report an error and exit
perror () {
  echo "Error: $1" >&2
  exit 1
}

# Check if everything is there to be used
[ -n "$CHECK_DELETED_LIBS" ] || p_error "check-deleted-libs binary is missing"
[ -x "$CHECK_DELETED_LIBS" ] || p_error "$CHECK_DELETED_LIBS not executable"
[ -r /etc/os-release ] || perror "Unable to read /etc/os-release, cannot identify the OS version"

. /etc/os-release
[ -z "$NAME" -o "$NAME" != "Ubuntu" ] && perror "This script only supports Ubuntu (not $NAME)"

service_action () {
  local svc_name="$1"
  local svc_action="$2"

  # Make sure the service is running before taking any action
  service "$svc_name" status >/dev/null 2>&1 && service "$svc_name" "$svc_action" >/dev/null
}

restart_dbus () {
   # Restarting dbus while lightdm is running breaks the graphical session
   status lightdm 2>/dev/null | grep -qF running || upstart_action dbus restart
}

send_signal () {
  local signal="$1"
  local proc_name="$2"

  # check if the signal is a valid one before sending it
  /bin/kill -l | grep -qw "$signal" && pkill -"$signal" -x "$proc_name"
}

upstart_action () {
  local job_name="$1"
  local job_action="$2"

  # Make sure Upstart job exist and Upstart is tracking the process
  if [ -e "/etc/init/$job_name.conf" ] && status $job_name | grep -qF running; then
    case "$job_action" in
      stop_start)
        stop "$job_name" > /dev/null && start "$job_name" > /dev/null
        ;;
      *)
        "$job_action" "$job_name" > /dev/null
        ;;
    esac
  fi
}

if [ "$#" -eq 1 ]; then
  EXCLUDE_LIST="$1"
else
  EXCLUDE_LIST="''"
fi

$CHECK_DELETED_LIBS | grep -vE "$EXCLUDE_LIST" | while read -r proc_name; do
  case "$proc_name" in
    acpid)
      upstart_action acpid restart
      ;;
    apache2)
      # does a graceful restart that won't restart the
      # master but will at least take care of the children
      service_action apache2 reload
      ;;
    atd)
      upstart_action atd restart
      ;;
    cron)
      upstart_action cron restart
      ;;
    dbus-daemon)
      restart_dbus
      ;;
    getty)
      send_signal HUP getty
      ;;
    irqbalance)
      upstart_action irqbalance restart
      ;;
    libvirtd)
      upstart_action libvirt-bin stop_start
      ;;
    mdadm)
      service_action mdadm restart
      ;;
    nginx)
      # Make sure the init script knows how to do in place
      # upgrades (replace the master bin)
      if [ -x "/etc/init.d/nginx" ] && /etc/init.d/nginx 2>&1 | grep -qF upgrade; then
        service_action nginx upgrade
      fi
      ;;
    nrpe)
      service_action nagios-nrpe-server restart
      ;;
    nsd)
      if [ -x "/etc/init.d/nsd" ]; then
        service_action nsd restart
      elif [ -x "/etc/init.d/nsd3" ]; then
        # nsd3's init script doesn't have "status"
        pgrep -x nsd > /dev/null && service nsd3 restart >/dev/null
      fi
      ;;
    ntpd)
      if [ -x /etc/init.d/openntpd ]; then
        service_action openntpd restart
      else
        service_action ntp restart
      fi
      ;;
    rsyslogd)
      upstart_action rsyslog restart
      ;;
    smartd)
      service_action smartmontools restart
      ;;
    sshd)
      # make sure the config wouldn't cause problem on restart
      sshd -T > /dev/null 2>&1 && upstart_action ssh restart
      ;;
    tlsmgr)
      service_action postfix reload
      ;;
    udevd|systemd-udevd)
      upstart_action udev restart
      ;;
    unbound)
      service_action unbound restart
      ;;
    upstart-udev-br)
      upstart_action upstart-udev-bridge restart
      ;;
    upstart-socket-)
      upstart_action upstart-socket-bridge restart
      ;;
  esac
done
